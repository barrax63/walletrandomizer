<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Wallets - Wallet Randomizer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üîê Wallet Randomizer</h1>
            <nav>
                <a href="/" class="btn btn-secondary">‚Üê Back to Home</a>
            </nav>
        </header>

        <main>
            <div class="generator-layout">
                <aside class="config-panel">
                    <h2>Configuration</h2>
                    <form id="generator-form">
                        <div class="form-group">
                            <label for="num-wallets">Number of Wallets</label>
                            <input 
                                type="number" 
                                id="num-wallets" 
                                name="num_wallets" 
                                min="1" 
                                max="10" 
                                value="{{ default_num_wallets }}"
                                required>
                            <small>Maximum: 10 wallets per request</small>
                        </div>

                        <div class="form-group">
                            <label for="num-addresses">Addresses per Wallet</label>
                            <input 
                                type="number" 
                                id="num-addresses" 
                                name="num_addresses" 
                                min="1" 
                                max="20" 
                                value="{{ default_num_addresses }}"
                                required>
                            <small>Maximum: 20 addresses per wallet</small>
                        </div>

                        <div class="form-group">
                            <label>BIP Derivation Types</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="bip_types" value="bip44" {% if 'bip44' in default_network %}checked{% endif %}>
                                    <span>BIP44 (Legacy P2PKH)</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="bip_types" value="bip49" {% if 'bip49' in default_network %}checked{% endif %}>
                                    <span>BIP49 (Nested SegWit)</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="bip_types" value="bip84" {% if 'bip84' in default_network %}checked{% endif %}>
                                    <span>BIP84 (Native SegWit)</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="bip_types" value="bip86" {% if 'bip86' in default_network %}checked{% endif %}>
                                    <span>BIP86 (Taproot)</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="word-count">Mnemonic Word Count</label>
                            <select id="word-count" name="word_count">
                                <option value="12" selected>12 words</option>
                                <option value="24">24 words</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="language">Mnemonic Language</label>
                            <select id="language" name="language">
                                <option value="english" selected>English</option>
                                <option value="french">French</option>
                                <option value="italian">Italian</option>
                                <option value="spanish">Spanish</option>
                                <option value="korean">Korean</option>
                                <option value="chinese_simplified">Chinese (Simplified)</option>
                                <option value="chinese_traditional">Chinese (Traditional)</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary" id="generate-btn">
                            Generate Wallets
                        </button>
                    </form>

                    <div class="info-box">
                        <h3>Fulcrum Server</h3>
                        <p><strong>Host:</strong> {{ fulcrum_host }}</p>
                        <p><strong>Port:</strong> {{ fulcrum_port }}</p>
                    </div>
                </aside>

                <section class="results-panel">
                    <div id="status-area">
                        <div class="empty-state">
                            <div class="empty-icon">üìù</div>
                            <h3>No wallets generated yet</h3>
                            <p>Configure your settings and click "Generate Wallets" to begin</p>
                        </div>
                    </div>

                    <div id="results-area" style="display: none;">
                        <h2>Results</h2>
                        <div id="results-content"></div>
                    </div>
                </section>
            </div>
        </main>

        <footer>
            <p>Wallet Randomizer | For educational and experimental purposes</p>
        </footer>
    </div>

    <script>
        const form = document.getElementById('generator-form');
        const generateBtn = document.getElementById('generate-btn');
        const statusArea = document.getElementById('status-area');
        const resultsArea = document.getElementById('results-area');
        const resultsContent = document.getElementById('results-content');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate BIP types
            const selectedBips = Array.from(document.querySelectorAll('input[name="bip_types"]:checked'))
                .map(cb => cb.value);
            
            if (selectedBips.length === 0) {
                alert('Please select at least one BIP derivation type');
                return;
            }

            // Get form data
            const formData = {
                num_wallets: parseInt(document.getElementById('num-wallets').value),
                num_addresses: parseInt(document.getElementById('num-addresses').value),
                bip_types: selectedBips,
                word_count: parseInt(document.getElementById('word-count').value),
                language: document.getElementById('language').value
            };

            // Show loading state
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';
            statusArea.innerHTML = `
                <div class="loading-state">
                    <div class="spinner"></div>
                    <h3>Generating wallets...</h3>
                    <p>Please wait while we generate ${formData.num_wallets} wallet(s) and check balances</p>
                </div>
            `;
            resultsArea.style.display = 'none';

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to generate wallets');
                }

                // Show success and results
                displayResults(data.wallets);
                statusArea.innerHTML = `
                    <div class="success-state">
                        <div class="success-icon">‚úì</div>
                        <h3>Success!</h3>
                        <p>Generated ${data.wallets.length} wallet(s)</p>
                    </div>
                `;

            } catch (error) {
                // Show error state
                statusArea.innerHTML = `
                    <div class="error-state">
                        <div class="error-icon">‚ö†Ô∏è</div>
                        <h3>Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
                resultsArea.style.display = 'none';
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate Wallets';
            }
        });

        function displayResults(wallets) {
            resultsArea.style.display = 'block';
            resultsContent.innerHTML = wallets.map(wallet => {
                const totalBalance = parseFloat(wallet.total_balance);
                const hasBalance = totalBalance > 0;

                return `
                    <div class="wallet-card ${hasBalance ? 'wallet-has-balance' : ''}">
                        <div class="wallet-header">
                            <h3>Wallet #${wallet.wallet_number}</h3>
                            <span class="balance ${hasBalance ? 'balance-positive' : ''}">
                                ${totalBalance.toFixed(8)} BTC
                            </span>
                        </div>
                        
                        ${hasBalance ? '<div class="balance-alert">üí∞ Balance found! Exported to JSON</div>' : ''}
                        
                        <div class="wallet-info">
                            <div class="info-row">
                                <strong>Mnemonic:</strong>
                                <code class="mnemonic">${wallet.mnemonic}</code>
                            </div>
                            <div class="info-row">
                                <strong>Language:</strong> ${wallet.language}
                            </div>
                            <div class="info-row">
                                <strong>Words:</strong> ${wallet.word_count}
                            </div>
                        </div>

                        ${wallet.bip_types.map(bip => `
                            <div class="bip-section">
                                <h4>${bip.type.toUpperCase()}</h4>
                                <div class="addresses-list">
                                    ${bip.addresses.map(addr => {
                                        const balance = parseFloat(addr.balance);
                                        return `
                                            <div class="address-row ${balance > 0 ? 'address-has-balance' : ''}">
                                                <code class="address">${addr.address}</code>
                                                <span class="address-balance">${balance.toFixed(8)} BTC</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');
        }
    </script>
</body>
</html>
